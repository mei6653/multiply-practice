<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2桁かけ算練習（10問・タイム付き）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 24px; }
    .card { max-width: 860px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 16px; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    .q { font-size: 36px; font-weight: 700; margin: 14px 0; letter-spacing: 1px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input[type="number"] { font-size: 22px; padding: 10px 12px; width: 220px; border-radius: 12px; border: 1px solid #bbb; }
    button { font-size: 18px; padding: 10px 14px; border-radius: 12px; border: 1px solid #666; background: #fff; cursor: pointer; }
    button:active { transform: translateY(1px); }
    .msg { margin-top: 12px; font-size: 18px; min-height: 28px; }
    .ok { color: #0a7; font-weight: 700; }
    .ng { color: #d33; font-weight: 700; }
    .stat { margin-top: 10px; color: #444; }
    .small { color: #666; font-size: 14px; margin-top: 12px; }
    .pill { display: inline-block; padding: 3px 10px; border: 1px solid #ccc; border-radius: 999px; margin-left: 6px; }
    .settings { margin-top: 14px; padding-top: 12px; border-top: 1px solid #eee; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f6f6f6; }
    .left { text-align: left; }
    .split { margin-top: 16px; padding-top: 14px; border-top: 1px solid #eee; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <div class="card">
    <h1>2桁のかけ算練習（10問・タイム付き）</h1>

    <!-- 問題画面 -->
    <div id="quizView">
      <div class="row stat">
        <div id="progress">1 / 10</div>
        <div class="pill mono">この問題：<span id="qTime">0.0</span>s</div>
        <div class="pill mono">合計：<span id="setTime">0.0</span>s</div>
      </div>

      <div class="q" id="question">-- × --</div>

      <div class="row">
        <input id="answer" type="number" inputmode="numeric" placeholder="答え" />
        <button id="checkBtn">判定（Enter）</button>
        <button id="skipBtn">わからない（0で回答）</button>
      </div>

      <div class="msg" id="message"></div>
      <div class="stat" id="stats">正解 0 / 0（0%）</div>

      <div class="settings">
        <div class="row">
          <label>最小 <input id="min" type="number" value="10" style="width:90px"></label>
          <label>最大 <input id="max" type="number" value="99" style="width:90px"></label>
          <button id="applyRange">範囲適用（次のセットから）</button>
          <button id="restartSet">10問セットを最初から</button>
        </div>
        <div class="small">※ 範囲は次の10問セットから反映。履歴はこの端末内に保存されます。</div>
      </div>
    </div>

    <!-- 結果画面 -->
    <div id="resultView" class="hidden">
      <div class="q" style="font-size:28px">結果</div>
      <div class="stat mono" id="scoreLine">得点：0 / 10（0%） / 合計：0.0s / 平均：0.0s</div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th class="left">問題</th>
            <th>あなたの回答</th>
            <th>正解</th>
            <th>判定</th>
            <th class="mono">時間(s)</th>
          </tr>
        </thead>
        <tbody id="resultBody"></tbody>
      </table>

      <div class="row" style="margin-top:12px">
        <button id="nextSet">次の10問へ</button>
        <button id="restartSameSet">同じ条件でやり直す</button>
      </div>

      <div class="split">
        <div class="row">
          <div class="stat" style="font-weight:700">履歴（この端末）</div>
          <button id="clearHistory">履歴を全削除</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>日時</th>
              <th>範囲</th>
              <th>得点</th>
              <th class="mono">合計(s)</th>
              <th class="mono">平均(s)</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
        <div class="small">※ 別端末と共有したい場合は、Firebase等のサーバ保存に変えられます。</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const quizView = $("quizView");
  const resultView = $("resultView");

  const questionEl = $("question");
  const answerEl = $("answer");
  const messageEl = $("message");
  const statsEl = $("stats");
  const progressEl = $("progress");

  const minEl = $("min");
  const maxEl = $("max");

  const qTimeEl = $("qTime");
  const setTimeEl = $("setTime");

  const scoreLineEl = $("scoreLine");
  const resultBodyEl = $("resultBody");

  const historyBodyEl = $("historyBody");

  const SET_SIZE = 10;
  const HISTORY_KEY = "multiply_practice_history_v1";

  let min = 10, max = 99;
  let a = 0, b = 0;

  // セット進行
  let index = 0;      // 0..9
  let correct = 0;
  let total = 0;
  let records = [];   // {a,b,user,ans,ok,sec}

  // タイマー
  let qStartMs = 0;         // 問題開始
  let setStartMs = 0;       // セット開始
  let timerId = null;

  function randInt(lo, hi) {
    return Math.floor(Math.random() * (hi - lo + 1)) + lo;
  }

  function nowMs() { return performance.now(); }

  function secSince(ms) {
    return (nowMs() - ms) / 1000;
  }

  function fmt1(x) { return (Math.round(x * 10) / 10).toFixed(1); }

  function clampRange() {
    let mn = Number(minEl.value);
    let mx = Number(maxEl.value);
    if (!Number.isFinite(mn) || !Number.isFinite(mx)) { mn = 10; mx = 99; }
    if (mn > mx) [mn, mx] = [mx, mn];
    mn = Math.max(0, Math.min(999, mn));
    mx = Math.max(0, Math.min(999, mx));
    return { mn, mx };
  }

  function applyRangeToState() {
    const { mn, mx } = clampRange();
    min = mn; max = mx;
    minEl.value = String(min);
    maxEl.value = String(max);
  }

  function updateStats() {
    const rate = total === 0 ? 0 : Math.round((correct / total) * 100);
    statsEl.textContent = `正解 ${correct} / ${total}（${rate}%）`;
    progressEl.textContent = `${Math.min(index + 1, SET_SIZE)} / ${SET_SIZE}`;
  }

  function tick() {
    // 表示だけ更新
    qTimeEl.textContent = fmt1(secSince(qStartMs));
    setTimeEl.textContent = fmt1(secSince(setStartMs));
  }

  function startTimer() {
    stopTimer();
    timerId = setInterval(tick, 100);
    tick();
  }

  function stopTimer() {
    if (timerId != null) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  function newProblem() {
    a = randInt(min, max);
    b = randInt(min, max);
    questionEl.textContent = `${a} × ${b}`;
    answerEl.value = "";
    messageEl.textContent = "";
    answerEl.focus();

    qStartMs = nowMs();
    startTimer();
  }

  function showQuiz() {
    resultView.classList.add("hidden");
    quizView.classList.remove("hidden");
    updateStats();
    newProblem();
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function saveHistory(entry) {
    const arr = loadHistory();
    arr.unshift(entry);
    // 多すぎると邪魔なので最大50件
    const clipped = arr.slice(0, 50);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(clipped));
  }

  function renderHistory() {
    const arr = loadHistory();
    historyBodyEl.innerHTML = "";
    arr.forEach(h => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${h.date}</td>
        <td>${h.min}〜${h.max}</td>
        <td>${h.correct}/${h.total}</td>
        <td class="mono">${h.totalSec}</td>
        <td class="mono">${h.avgSec}</td>
      `;
      historyBodyEl.appendChild(tr);
    });
  }

  function showResult() {
    stopTimer();
    quizView.classList.add("hidden");
    resultView.classList.remove("hidden");

    const totalSec = records.reduce((s, r) => s + r.sec, 0);
    const avgSec = totalSec / SET_SIZE;
    const rate = Math.round((correct / SET_SIZE) * 100);

    scoreLineEl.textContent =
      `得点：${correct} / ${SET_SIZE}（${rate}%） / 合計：${fmt1(totalSec)}s / 平均：${fmt1(avgSec)}s`;

    resultBodyEl.innerHTML = "";
    records.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td class="left">${r.a} × ${r.b}</td>
        <td>${r.user}</td>
        <td>${r.ans}</td>
        <td>${r.ok ? '○' : '×'}</td>
        <td class="mono">${fmt1(r.sec)}</td>
      `;
      resultBodyEl.appendChild(tr);
    });

    // 履歴へ保存（日時/範囲/得点/時間）
    const d = new Date();
    const dateStr = d.toLocaleString("ja-JP", { hour12: false });
    saveHistory({
      date: dateStr,
      min, max,
      correct, total: SET_SIZE,
      totalSec: fmt1(totalSec),
      avgSec: fmt1(avgSec)
    });

    renderHistory();
  }

  function startNewSet(resetRange = false) {
    if (resetRange) applyRangeToState();

    index = 0;
    correct = 0;
    total = 0;
    records = [];

    setStartMs = nowMs();
    showQuiz();
  }

  function finishIfNeeded() {
    if (index >= SET_SIZE) {
      showResult();
      return true;
    }
    return false;
  }

  function submitAnswer(value) {
    const v = Number(value);
    if (!Number.isFinite(v)) return;

    const ans = a * b;
    const ok = (v === ans);
    const sec = secSince(qStartMs);

    total++;
    if (ok) correct++;

    records.push({ a, b, user: v, ans, ok, sec });

    if (ok) {
      messageEl.innerHTML = `<span class="ok">○ 正解！</span> <span class="pill">${a}×${b}=${ans}</span>`;
    } else {
      messageEl.innerHTML = `<span class="ng">× ちがう</span> <span class="pill">正解：${ans}</span>`;
    }

    updateStats();

    index++;
    if (finishIfNeeded()) return;

    setTimeout(newProblem, 450);
  }

  // イベント
  $("checkBtn").addEventListener("click", () => submitAnswer(answerEl.value));

  $("skipBtn").addEventListener("click", () => {
    answerEl.value = "0";
    submitAnswer(0);
  });

  answerEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") submitAnswer(answerEl.value);
  });

  $("applyRange").addEventListener("click", () => {
    const { mn, mx } = clampRange();
    minEl.value = String(mn);
    maxEl.value = String(mx);
    messageEl.textContent = `範囲は次の10問セットから ${mn}〜${mx} にします`;
  });

  $("restartSet").addEventListener("click", () => {
    startNewSet(true);
  });

  $("nextSet").addEventListener("click", () => {
    startNewSet(true);
  });

  $("restartSameSet").addEventListener("click", () => {
    startNewSet(false);
  });

  $("clearHistory").addEventListener("click", () => {
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
  });

  // 初期化
  applyRangeToState();
  renderHistory();
  startNewSet(false);
})();
</script>
</body>
</html>
